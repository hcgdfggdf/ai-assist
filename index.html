<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sharon AI</title>
  <style>
    :root { --bg: #0a0a0a; --card: #161616; --accent: #7c4dff; --text: #f0f0f0; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; height: 100vh; }
    .chat-container { width: 95%; max-width: 450px; height: 80vh; background: var(--card); border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #333; }
    #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .message { max-width: 85%; padding: 10px; border-radius: 10px; font-size: 0.9rem; }
    .user-msg { align-self: flex-end; background: var(--accent); }
    .ai-msg { align-self: flex-start; background: #2a2a2a; }
    .input-area { padding: 15px; border-top: 1px solid #333; display: flex; gap: 5px; }
    input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: #fff; }
    button { padding: 10px 15px; background: var(--accent); border: none; color: #fff; border-radius: 5px; cursor: pointer; }
    button:disabled { opacity: 0.3; }
  </style>
</head>
<body>

<div class="chat-container">
  <div id="messages"><div class="message ai-msg" id="status">Loading...</div></div>
  <div class="input-area">
    <input type="text" id="input" placeholder="Wait for it..." disabled>
    <button id="btn" disabled>Send</button>
  </div>
</div>

<script type="module">
  // Using the most stable production build
  import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

  // Force single-thread and no-cache to prevent the 100% hang
  env.allowLocalModels = false;
  env.backends.onnx.wasm.numThreads = 1;
  env.backends.onnx.wasm.simd = false; // Disabling SIMD fixes hangs on older/mobile browsers

  const msgDiv = document.getElementById("messages");
  const status = document.getElementById("status");
  const input = document.getElementById("input");
  const btn = document.getElementById("btn");

  let pipe = null;

  async function init() {
    try {
      // Swapping to a 'Text2Text' model - much more stable for web than 'Text-Generation'
      pipe = await pipeline("text2text-generation", "Xenova/flan-t5-small");
      
      status.innerText = "Sharon is online. Be quick.";
      input.disabled = false;
      btn.disabled = false;
      input.placeholder = "Say something...";
    } catch (e) {
      status.innerText = "Error: " + e.message;
    }
  }

  async function send() {
    const text = input.value.trim();
    if (!text) return;

    const u = document.createElement("div");
    u.className = "message user-msg";
    u.innerText = text;
    msgDiv.appendChild(u);
    input.value = "";

    const loading = document.createElement("div");
    loading.className = "message ai-msg";
    loading.innerText = "...";
    msgDiv.appendChild(loading);

    try {
      const res = await pipe(text, { max_new_tokens: 50 });
      loading.innerText = res[0].generated_text || "Whatever.";
    } catch (err) {
      loading.innerText = "My head hurts. (Error)";
    }
    msgDiv.scrollTop = msgDiv.scrollHeight;
  }

  btn.onclick = send;
  input.onkeypress = (e) => { if(e.key === 'Enter') send(); };
  init();
</script>
</body>
</html>
