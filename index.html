<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sharron AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans">

    <header class="bg-white border-b p-4 flex justify-between items-center shadow-sm">
        <h1 class="text-xl font-bold text-blue-600">Sharron AI</h1>
        <div id="status" class="text-xs font-mono bg-gray-200 px-2 py-1 rounded">Initializing...</div>
    </header>

    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 max-w-2xl mx-auto w-full">
        <div class="bg-blue-100 text-blue-800 p-3 rounded-lg text-sm">
            <b>System:</b> I'm downloading about 150MB of brain-power to your browser. Please wait...
        </div>
    </div>

    <div class="p-4 bg-white border-t">
        <div class="max-w-2xl mx-auto flex gap-2">
            <input type="text" id="user-input" placeholder="Loading Sharron..." disabled
                class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-gray-50">
            <button id="send-btn" disabled class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold disabled:opacity-50">
                Ask
            </button>
        </div>
    </div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0';

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const status = document.getElementById('status');

        let generator;

        async function init() {
            try {
                generator = await pipeline('text-generation', 'onnx-community/SmolLM2-135M-Instruct-ONNX', {
                    device: 'webgpu', 
                });
                
                status.innerText = "Ready";
                status.className = "text-xs font-mono bg-green-200 text-green-800 px-2 py-1 rounded";
                userInput.placeholder = "Say something to Sharron...";
                userInput.disabled = false;
                sendBtn.disabled = false;
            } catch (err) {
                console.error(err);
                status.innerText = "WebGPU failed, trying CPU...";
                generator = await pipeline('text-generation', 'onnx-community/SmolLM2-135M-Instruct-ONNX');
                status.innerText = "Ready (CPU Mode)";
            }
        }

        async function chat() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            appendMsg('You', prompt, 'bg-white');
            userInput.value = '';
            
            const thinkingDiv = appendMsg('Sharron', 'Thinking...', 'bg-blue-50');
            
            // Added a system message here so the AI knows its identity
            const messages = [
                { role: "system", content: "Your name is Sharron. You are a helpful AI assistant." },
                { role: "user", content: prompt }
            ];
            
            const output = await generator(messages, { 
                max_new_tokens: 128,
                temperature: 0.7 
            });

            // The output index changes slightly because we added a system message
            const responseText = output[0].generated_text[output[0].generated_text.length - 1].content;
            
            thinkingDiv.innerHTML = `<b>Sharron:</b> ${responseText}`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function appendMsg(sender, text, color) {
            const div = document.createElement('div');
            div.className = `${color} p-3 rounded-lg shadow-sm border border-gray-100 text-sm`;
            div.innerHTML = `<b>${sender}:</b> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        sendBtn.onclick = chat;
        userInput.onkeydown = (e) => { if(e.key === 'Enter') chat() };

        init();
    </script>
</body>
</html>
